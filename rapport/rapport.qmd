---
title: "Rapport — Périmètres irrigués"
subtitle: "Data processing, KPI & visualisations"
author: "Hamrouni Mariem"
date: today
lang: fr
---

```{python}
#| label: setup
#| include: false
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

DATA_PATH = (Path("..") / "data" / "perimetres-irrigues-public.xlsx").resolve()
df_raw = pd.read_excel(DATA_PATH)
```

# Inspection des données

```{python}
df_raw.shape
```

```{python}
df_raw.head(10)
```

```{python}
df_raw.dtypes
```

# Data processing

```{python}
df = df_raw.rename(columns={
    "Nom Délégation": "Nom_Delegation_fr",
    "Nom Delegation_arabe": "Nom_Delegation_ar",
    "Superficies irrigables_ha": "Irrigable_ha",
    "Superficies irriguées_ha": "Irriguee_ha",
    "Superficies exploitées_ha": "Exploitee_ha",
}).copy()

df["Année"] = pd.to_numeric(df["Année"], errors="coerce").astype("Int64")
for col in ["Irrigable_ha","Irriguee_ha","Exploitee_ha"]:
    df[col] = pd.to_numeric(df[col], errors="coerce")

df["Taux_irrigation_%"] = (df["Irriguee_ha"] / df["Irrigable_ha"]) * 100
df["Taux_exploitation_%"] = (df["Exploitee_ha"] / df["Irrigable_ha"]) * 100

before = len(df)
df = df.drop_duplicates()
(before - len(df)), df.shape
```

## Valeurs manquantes

```{python}
na = (df.isna().mean()*100).round(2).sort_values(ascending=False)
na.to_frame("pourcentage_NA")
```

```{python}
plt.figure(figsize=(9,3.8))
plt.bar(na.index.astype(str), na.values)
plt.xticks(rotation=45, ha="right")
plt.title("Valeurs manquantes (%)")
plt.tight_layout()
plt.show()
```

# KPI

```{python}
kpi = {
    "Nb lignes": len(df),
    "Nb délégations": df["Nom_Delegation_fr"].nunique(dropna=True),
    "Nb années": df["Année"].nunique(dropna=True),
    "Total irrigable (ha)": round(float(df["Irrigable_ha"].sum()), 2),
    "Total irriguée (ha)": round(float(df["Irriguee_ha"].sum()), 2),
    "Total exploitée (ha)": round(float(df["Exploitee_ha"].sum()), 2),
    "Taux irrigation moyen (%)": round(float(df["Taux_irrigation_%"].mean()), 2),
    "Taux exploitation moyen (%)": round(float(df["Taux_exploitation_%"].mean()), 2),
}
kpi_df = pd.DataFrame({"KPI": kpi.keys(), "Valeur": kpi.values()})
kpi_df
```

# Visualisations

## Évolution annuelle (sommes)

```{python}
year = df.groupby("Année")[["Irrigable_ha","Irriguee_ha","Exploitee_ha"]].sum().sort_index()

plt.figure(figsize=(8,4))
plt.plot(year.index.astype(int), year["Irrigable_ha"], marker="o", label="Irrigable")
plt.plot(year.index.astype(int), year["Irriguee_ha"], marker="o", label="Irriguée")
plt.plot(year.index.astype(int), year["Exploitee_ha"], marker="o", label="Exploitée")
plt.title("Évolution annuelle des superficies (ha)")
plt.xlabel("Année"); plt.ylabel("Hectares")
plt.legend()
plt.tight_layout()
plt.show()

year
```

## Taux moyens par année

```{python}
ty = df.groupby("Année")[["Taux_irrigation_%","Taux_exploitation_%"]].mean().sort_index()

plt.figure(figsize=(8,4))
plt.plot(ty.index.astype(int), ty["Taux_irrigation_%"], marker="o", label="Taux irrigation (%)")
plt.plot(ty.index.astype(int), ty["Taux_exploitation_%"], marker="o", label="Taux exploitation (%)")
plt.title("Évolution des taux moyens (%)")
plt.xlabel("Année"); plt.ylabel("%")
plt.legend()
plt.tight_layout()
plt.show()

ty
```

## Top délégations (taux irrigation)

```{python}
top = (df.groupby("Nom_Delegation_fr")["Taux_irrigation_%"].mean()
       .sort_values(ascending=False).head(10))

plt.figure(figsize=(10,4))
plt.bar(top.index.astype(str), top.values)
plt.xticks(rotation=60, ha="right")
plt.title("Top 10 délégations — Taux d'irrigation moyen (%)")
plt.tight_layout()
plt.show()

top.to_frame("Taux_irrigation_moyen_%")
```

## Scatter : irrigable vs irriguée

```{python}
plt.figure(figsize=(6,4))
plt.scatter(df["Irrigable_ha"], df["Irriguee_ha"])
plt.title("Irrigable (ha) vs Irriguée (ha)")
plt.xlabel("Irrigable (ha)")
plt.ylabel("Irriguée (ha)")
plt.tight_layout()
plt.show()
```

## Heatmap : délégation × année (taux irrigation)

```{python}
pivot = df.pivot_table(index="Nom_Delegation_fr", columns="Année", values="Taux_irrigation_%", aggfunc="mean")
top12 = df["Nom_Delegation_fr"].value_counts().head(12).index
p2 = pivot.loc[pivot.index.isin(top12)]

plt.figure(figsize=(9,4.8))
plt.imshow(p2.values, aspect="auto")
plt.colorbar(label="Taux irrigation (%)")
plt.xticks(range(len(p2.columns)), p2.columns.astype(int))
plt.yticks(range(len(p2.index)), p2.index.astype(str))
plt.title("Heatmap — Taux irrigation (%) | Top 12 délégations × années")
plt.tight_layout()
plt.show()

p2
```

# Conclusion

- Prétraitement : renommage, typage, calcul des taux, doublons
- KPI : synthèse globale
- Visualisations : évolution, comparaison, analyse croisée

# Annexes

## Exports

```{python}
#| echo: true
df.to_csv("perimetres_irrigues_clean.csv", index=False, encoding="utf-8")
kpi_df.to_csv("kpi_perimetres_irrigues.csv", index=False, encoding="utf-8")
print("✅ Exports générés.")
```
