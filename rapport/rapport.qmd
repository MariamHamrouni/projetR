---
title: "Rapport — Périmètres irrigués"
subtitle: "Data processing, KPI & visualisations"
author: "Hamrouni Mariem"
date: today
lang: fr
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 3
    number-sections: true
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false

library(readxl)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(knitr)
library(scales)
```

```{r}
#| label: load
#| include: false

DATA_PATH <- file.path("..", "data", "perimetres-irrigues-public.xlsx")
df_raw <- read_excel(DATA_PATH)

# Nettoyage des noms
names(df_raw) <- str_trim(names(df_raw))

# Debug (décommente si besoin)
# print(names(df_raw))
```

# Inspection des données

```{r}
dim(df_raw)
```

```{r}
head(df_raw, 10)
```

```{r}
str(df_raw)
```

# Data processing

```{r}
rename_if_exists <- function(.data, old, new) {
  if (old %in% names(.data)) dplyr::rename(.data, !!new := all_of(old)) else .data
}

df <- df_raw %>%
  rename_if_exists("Nom Délégation", "Nom_Delegation_fr") %>%
  rename_if_exists("Nom Delegation_arabe", "Nom_Delegation_ar") %>%
  rename_if_exists("Superficies irrigables_ha", "Irrigable_ha") %>%
  rename_if_exists("Superficies irriguées_ha", "Irriguee_ha") %>%
  rename_if_exists("Superficies exploitées_ha", "Exploitee_ha")

df <- df %>%
  mutate(
    Année = suppressWarnings(as.integer(Année)),
    Irrigable_ha = suppressWarnings(as.numeric(Irrigable_ha)),
    Irriguee_ha = suppressWarnings(as.numeric(Irriguee_ha)),
    Exploitee_ha = suppressWarnings(as.numeric(Exploitee_ha))
  ) %>%
  mutate(
    Taux_irrigation_pct = (Irriguee_ha / Irrigable_ha) * 100,
    Taux_exploitation_pct = (Exploitee_ha / Irrigable_ha) * 100
  )

before <- nrow(df)
df <- df %>% distinct()
c(doublons_supprimes = before - nrow(df), n_lignes = nrow(df), n_colonnes = ncol(df))
```

## Valeurs manquantes

```{r}
na_df <- df %>%
  summarise(across(everything(), ~ mean(is.na(.)) * 100)) %>%
  pivot_longer(everything(), names_to = "colonne", values_to = "pourcentage_NA") %>%
  arrange(desc(pourcentage_NA))

na_df
```

```{r}
ggplot(na_df, aes(x = reorder(colonne, -pourcentage_NA), y = pourcentage_NA)) +
  geom_col() +
  labs(title = "Valeurs manquantes (%)", x = NULL, y = "%") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# KPI

```{r}
kpi <- tibble(
  KPI = c(
    "Nb lignes",
    "Nb délégations",
    "Nb années",
    "Total irrigable (ha)",
    "Total irriguée (ha)",
    "Total exploitée (ha)",
    "Taux irrigation moyen (%)",
    "Taux exploitation moyen (%)"
  ),
  Valeur = c(
    nrow(df),
    n_distinct(df$Nom_Delegation_fr, na.rm = TRUE),
    n_distinct(df$Année, na.rm = TRUE),
    round(sum(df$Irrigable_ha, na.rm = TRUE), 2),
    round(sum(df$Irriguee_ha, na.rm = TRUE), 2),
    round(sum(df$Exploitee_ha, na.rm = TRUE), 2),
    round(mean(df$Taux_irrigation_pct, na.rm = TRUE), 2),
    round(mean(df$Taux_exploitation_pct, na.rm = TRUE), 2)
  )
)

kpi
```

# Visualisations

## Évolution annuelle (sommes)

```{r}
year <- df %>%
  group_by(Année) %>%
  summarise(
    Irrigable_ha = sum(Irrigable_ha, na.rm = TRUE),
    Irriguee_ha = sum(Irriguee_ha, na.rm = TRUE),
    Exploitee_ha = sum(Exploitee_ha, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Année)

year_long <- year %>%
  pivot_longer(-Année, names_to = "Type", values_to = "Hectares")

ggplot(year_long, aes(x = Année, y = Hectares, color = Type)) +
  geom_line() +
  geom_point() +
  labs(title = "Évolution annuelle des superficies (ha)", x = "Année", y = "Hectares") +
  theme_minimal()
```

## Taux moyens par année

```{r}
ty <- df %>%
  group_by(Année) %>%
  summarise(
    Taux_irrigation_pct = mean(Taux_irrigation_pct, na.rm = TRUE),
    Taux_exploitation_pct = mean(Taux_exploitation_pct, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Année)

ty_long <- ty %>%
  pivot_longer(-Année, names_to = "Type", values_to = "Taux")

ggplot(ty_long, aes(x = Année, y = Taux, color = Type)) +
  geom_line() +
  geom_point() +
  labs(title = "Évolution des taux moyens (%)", x = "Année", y = "%") +
  theme_minimal()
```

## Top 10 délégations (taux irrigation)

```{r}
top <- df %>%
  group_by(Nom_Delegation_fr) %>%
  summarise(Taux_irrigation_moyen = mean(Taux_irrigation_pct, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Taux_irrigation_moyen)) %>%
  slice_head(n = 10)

ggplot(top, aes(x = reorder(Nom_Delegation_fr, Taux_irrigation_moyen), y = Taux_irrigation_moyen)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 10 délégations — Taux d'irrigation moyen (%)", x = NULL, y = "%") +
  theme_minimal()
```

## Scatter : irrigable vs irriguée

```{r}
ggplot(df, aes(x = Irrigable_ha, y = Irriguee_ha)) +
  geom_point(alpha = 0.6) +
  labs(title = "Irrigable (ha) vs Irriguée (ha)", x = "Irrigable (ha)", y = "Irriguée (ha)") +
  theme_minimal()
```

## Heatmap : délégation × année (taux irrigation)

```{r}
top12_names <- df %>%
  count(Nom_Delegation_fr, sort = TRUE) %>%
  slice_head(n = 12) %>%
  pull(Nom_Delegation_fr)

heat <- df %>%
  filter(Nom_Delegation_fr %in% top12_names) %>%
  group_by(Nom_Delegation_fr, Année) %>%
  summarise(taux = mean(Taux_irrigation_pct, na.rm = TRUE), .groups = "drop")

ggplot(heat, aes(x = Année, y = Nom_Delegation_fr, fill = taux)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "steelblue", na.value = "grey90") +
  labs(title = "Heatmap — Taux irrigation (%) | Top 12 délégations × années",
       x = "Année", y = NULL, fill = "%") +
  theme_minimal()
```

# Conclusion

- Prétraitement : renommage, typage, calcul des taux, doublons
- KPI : synthèse globale
- Visualisations : évolution, comparaison, analyse croisée

# Annexes

## Exports

```{r}
#| echo: true
write.csv(df, "perimetres_irrigues_clean.csv", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(kpi, "kpi_perimetres_irrigues.csv", row.names = FALSE, fileEncoding = "UTF-8")
cat("✅ Exports générés : perimetres_irrigues_clean.csv, kpi_perimetres_irrigues.csv\n")
```
